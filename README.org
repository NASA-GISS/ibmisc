
#+PROPERTY: header-args:bash+ :prologue exec 2>&1 && eval "$(conda shell.bash hook)" && conda activate meli
#+PROPERTY: header-args:bash+ :epilogue ":"

* Build instructions

** Set up conda environment

#+BEGIN_SRC bash :exports both :results verbatim
rm -fR ~/local/mambaforge/envs/ibmisc/
mamba create -n ibmisc # model E land ice
mamba activate ibmisc
# mamba install eigen=3.2.8 netcdf-cxx4=4.3.0 proj4 cython gtest boost # MAKE works

mamba install -y eigen=3.2.8 netcdf-cxx4=4.3.0 proj4 cython gtest boost libboost-mpi mpfr
#+END_SRC

Edit =${CONDA_EXE}/../../envs/meli/include/proj_api.h= and set =#define ACCEPT_USE_OF_DEPRECATED_PROJ_API_H=1=

** Everytrace

In =~/projects/GISS=

#+BEGIN_SRC bash :exports both :results verbatim
gh repo clone NASA-GISS/everytrace
cd everytrace
mkdir build
cmake -B build . -DUSE_FORTRAN=YES -DUSE_MPI=YES
cd build
make
#+END_SRC

** Blitz

In =~/projects/GISS=

#+BEGIN_SRC bash :exports both :results verbatim
gh repo clone blitzpp/blitz
cd blitz
mkdir build
cd build
cmake .. -DCMAKE_INSTALL_PREFIX=./install
make
make install
#+END_SRC


** IBMISC

In =~/projects/GISS/ibmisc/build=

#+BEGIN_SRC bash :exports both :results verbatim
mkdir -p build
cd build

rm -fR *

export MELI_ROOT=/home/kdm/projects/GISS
export EVERYTRACE=${MELI_ROOT}/everytrace
export BLITZ=${MELI_ROOT}/blitz/build/install
export IBMISC_ENV=${HOME}/local/mambaforge/envs/ibmisc
export CMAKE_PREFIX_PATH=${IBMISC_ENV}/lib:${IBMISC_ENV}/include:${EVERYTRACE}/slib
export CMAKE_MODULE_PATH=${IBMISC_ENV}/lib:${IBMISC_ENV}/include

cmake .. \
      -DUSE_BLITZ=YES \
      -DCMAKE_CXX_FLAGS=-fpermissive \
      -DBLITZ_ROOT=${BLITZ} \
      -DBLITZ_LIBRARY=${BLITZ}/lib/libblitz.so \
      -DCMAKE_INSTALL_PREFIX=./install \
      -DEVERYTRACE_c_REFADDR=${EVERYTRACE}/build/slib \
      -DEVERYTRACE_INCLUDE_DIR=${EVERYTRACE}/slib \
      -DEVERYTRACE_LIBRARY=${EVERYTRACE}/build/slib/libeverytrace.so \
      -DGTEST_LIBRARY_MAIN=${IBMISC_ENV}/lib/libgtest.so \
      -DNETCDF_C_ROOT=${IBMISC_ENV} \
      -DNETCDF_CXX4_INCLUDE_DIR=${IBMISC_ENV}/include \
      -DNETCDF_CXX4_LIBRARY=${IBMISC_ENV}/lib/libnetcdf_c++4.so \
      -DNETCDF_C_LIBRARY=${IBMISC_ENV}/lib/libnetcdf.so \
      -DZLIB_INCLUDE_DIRS=${IBMISC_ENV}/include \
      -DZLIB_LIBRARIES=${IBMISC_ENV}/lib/zlib.so

make
make install
#+END_SRC


